<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Reduct Html</title>
</head>

<body>
    <h1>Reduct</h1>
    <h4>the revolt.chat client held together by duct tape and bad code</h4>
    <br />
    <div id="loginoe">
        <input id="token" alt="aaa" placeholder="Token">
        <br><input id="channel" placeholder="Channel ID">
        <br><input id="inputTheme" placeholder="Theme">
        <br><button onclick="login()">ok</button>
        <br /><br /><br />
    </div>
    <div id="logged" hidden="true">
        <button onclick="getmessage()">Get messages</button>
        <button onclick="embedmessage()">Send embed</button>
        <br>
        <input type="text" style="width: 90%;" autocomplete="off" placeholder="Title" id="title" hidden="true"/>
        <input type="text" style="width: 90%;" autocomplete="off" placeholder="Description" id="desc" hidden="true"/>
        <input type="text" style="width: 90%;" autocomplete="off" placeholder="Color" id="color" hidden="true"/>
        <button onclick="contentToJson()">JSON</button>
        <input type="text" style="width: 90%;" autocomplete="off" placeholder="Speak in channel" id="a" />
        <button onclick="sendmessage()">Send</button>
        <br>
    </div>
    <h2 id="theme"></h2>
    <br />
    <div id="messages" hidden="true">
    </div>

    <style>
        span {
            border-style: dotted;
        }

        .loginoe {
            display: flex;
            align-items: center;
        }

        h5 {
            border-style: solid;
            border-width: 1px;
        }
    </style>

    <script>
        let embedSend=false
        function embedmessage(){
            document.getElementById("title").hidden = false
            document.getElementById("desc").hidden = false
            document.getElementById("color").hidden = false
            embedSend=true
        }
        document.getElementById("a").onkeypress = function (event) {
            if (event.keyCode == 13 || event.which == 13) {
                sendmessage()
            }
        }
        let sendRawJson = false;
        function contentToJson() {
            if (!sendRawJson) {
                sendRawJson = true
            }
            else { sendRawJson = false }
        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function login() {
            for (let i = 1; i < 51; i++) {
                document.getElementById("messages").innerHTML += `<span id="a${i}">author </span>
                    <h5 id = "${i}msg" > message</h5 ><br /><br />`
            }
            var theme
            thetoken = document.getElementById("token").value;
            thechannel = document.getElementById("channel").value;
            document.getElementById("loginoe").hidden = true;
            document.getElementById("logged").hidden = false;
            //if (!document.getElementById("inputTheme").value == '') { document.cookie = `theme=${document.getElementById("inputTheme").value};` }
            //if (document.cookie) { let theme = document.cookie.split('; ').find(row => row.startsWith('theme=')).split('=')[1]; }
            theme = document.getElementById("inputTheme").value
            document.getElementById("theme").innerHTML = theme;
            await getmessage();
            while (1) { await sleep(10000); await getmessage() }
        }

        async function sendmessage() {
            if(embedSend){
                await fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                    "credentials": "omit",
                    "headers": {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "x-session-token": thetoken
                    },
                    "body": `{
                        "nonce":"",
                        "content":"${document.getElementById("a").value}",
                        "embeds":[
                            {
                                "title":"${document.getElementById("title").value}",
                                "description":"${document.getElementById("desc").value}",
                                "colour":"${document.getElementById("color").value}"
                            }
                        ]
                    }`,
                    "method": "POST"
                })
                document.getElementById("title").hidden = true
                document.getElementById("desc").hidden = true
                document.getElementById("color").hidden = true
                document.getElementById("title").value = ""
                document.getElementById("desc").value = ""
                document.getElementById("color").value = ""
            }
            else{
                if (sendRawJson) {
                await fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                    "credentials": "omit",
                    "headers": {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "x-session-token": thetoken
                    },
                    "body": document.getElementById("a").value,
                    "method": "POST"
                })
            } else {
                await fetch("https://api.revolt.chat/channels/" + thechannel + "/messages", {
                    "credentials": "omit",
                    "headers": {
                        "Accept": "*/*",
                        "Content-Type": "application/json",
                        "x-session-token": thetoken
                    },
                    "body": `{"nonce":"","content":"${document.getElementById("a").value}","replies":[]}"`,
                    "method": "POST"
                })
                document.getElementById("a").value = ""
            }
        }
            getmessage();
        }
        async function replacea() {
            for (let i = 1; i < 51; i++) {
                id = document.getElementById("a" + i).innerHTML;
                await getuser(id);

                document.getElementById("a" + i).innerText = membo;
            }
            document.getElementById("rplca").hidden = true;
        }

        async function getuser(id) {
            await fetch("https://api.revolt.chat/users/" + id, {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken
                },
                "method": "GET",
            }).then(response => response.json())
                .then(data => membo = (data.username));
        }


        async function getmessage() {
            document.getElementById("messages").hidden = false
            await fetch("https://api.revolt.chat/channels/" + thechannel + "/messages?include_users=true", {
                "credentials": "omit",
                "headers": {
                    "Accept": "*/*",
                    "x-session-token": thetoken,
                },
                "method": "GET",
            }).then(response => response.json())
                .then(data => mess = (data.messages))
            for (let i = 1; i < 50; i++) {
                document.getElementById("a" + i).innerText = mess[i-1].author;
            }
            replacea();
            for (let i = 1; i < 50; i++) {
                document.getElementById(`${i}msg`).innerText = mess[i-1].content;
            }

            document.getElementById("rplca").hidden = false
        }
    </script>
</body>

</html>
